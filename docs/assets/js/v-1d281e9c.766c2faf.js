"use strict";(self.webpackChunkziqiangxu_github_io=self.webpackChunkziqiangxu_github_io||[]).push([[7804],{699:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-1d281e9c",path:"/accumulation/Linux%E9%80%9A%E8%BF%87%E8%AF%BB%E5%8F%96%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6%E7%9B%91%E5%90%AC%E9%94%AE%E7%9B%98.html",title:"通过读取设备文件监听 Linux 键盘事件",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"扩展阅读",slug:"扩展阅读",children:[]}],filePathRelative:"accumulation/Linux通过读取设备文件监听键盘.md",git:{updatedTime:1601993027e3,contributors:[{name:"daryl",email:"ziqiang_xu@qq.com",commits:4},{name:"Daryl.Xu",email:"ziqiang_xu@yeah.net",commits:1},{name:"daryl",email:"ziqiang_xu@yeah.net",commits:1}]}}},9931:(n,s,a)=>{a.r(s),a.d(s,{default:()=>i});var e=a(6252);const t=a.p+"assets/img/listen-input-devices.31592697.png",m=(0,e.Wm)("h1",{id:"通过读取设备文件监听-linux-键盘事件",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#通过读取设备文件监听-linux-键盘事件","aria-hidden":"true"},"#"),(0,e.Uk)(" 通过读取设备文件监听 "),(0,e.Wm)("code",null,"Linux"),(0,e.Uk)(" 键盘事件")],-1),c=(0,e.Wm)("div",{class:"language-cpp ext-cpp line-numbers-mode"},[(0,e.Wm)("pre",{class:"language-cpp"},[(0,e.Wm)("code",null,[(0,e.Wm)("span",{class:"token macro property"},[(0,e.Wm)("span",{class:"token directive-hash"},"#"),(0,e.Wm)("span",{class:"token directive keyword"},"include"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},"<stdio.h>")]),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token macro property"},[(0,e.Wm)("span",{class:"token directive-hash"},"#"),(0,e.Wm)("span",{class:"token directive keyword"},"include"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},"<linux/input.h>")]),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token macro property"},[(0,e.Wm)("span",{class:"token directive-hash"},"#"),(0,e.Wm)("span",{class:"token directive keyword"},"include"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},"<fcntl.h>")]),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token macro property"},[(0,e.Wm)("span",{class:"token directive-hash"},"#"),(0,e.Wm)("span",{class:"token directive keyword"},"include"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},"<unistd.h>")]),(0,e.Uk)("\n\n"),(0,e.Wm)("span",{class:"token macro property"},[(0,e.Wm)("span",{class:"token directive-hash"},"#"),(0,e.Wm)("span",{class:"token directive keyword"},"define"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token macro-name"},"DEV_PATH"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"/dev/input/event5"'),(0,e.Uk)("   "),(0,e.Wm)("span",{class:"token comment"},"//根据需要修改为你的键盘对应的设备文件，可以直接sudo cat /dev/input/event5并按键盘，看是否有输出，见附图")]),(0,e.Uk)("\n\n"),(0,e.Wm)("span",{class:"token keyword"},"int"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"main"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token keyword"},"int"),(0,e.Uk)(" keys_fd"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("  "),(0,e.Wm)("span",{class:"token comment"},"//文件标志"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token keyword"},"char"),(0,e.Uk)(" ret"),(0,e.Wm)("span",{class:"token punctuation"},"["),(0,e.Wm)("span",{class:"token number"},"2"),(0,e.Wm)("span",{class:"token punctuation"},"]"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token keyword"},"struct"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token class-name"},"input_event"),(0,e.Uk)(" t"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("  "),(0,e.Wm)("span",{class:"token comment"},"//读取到的input设备数据是一个结构体"),(0,e.Uk)("\n\n    keys_fd "),(0,e.Wm)("span",{class:"token operator"},"="),(0,e.Uk)(),(0,e.Wm)("span",{class:"token function"},"open"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("DEV_PATH"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)(" O_RDONLY"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("  "),(0,e.Wm)("span",{class:"token comment"},"//权限不通过的时候一般会返回-1"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token keyword"},"if"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("keys_fd "),(0,e.Wm)("span",{class:"token operator"},"<="),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"0"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token function"},"printf"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Wm)("span",{class:"token string"},'"open /dev/input/event2 device error!\\n"'),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token operator"},"-"),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token keyword"},"while"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token keyword"},"if"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token function"},"read"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("keys_fd"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e.Wm)("span",{class:"token operator"},"&"),(0,e.Uk)("t"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e.Wm)("span",{class:"token keyword"},"sizeof"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("t"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token operator"},"=="),(0,e.Uk)(),(0,e.Wm)("span",{class:"token keyword"},"sizeof"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("t"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)("  "),(0,e.Wm)("span",{class:"token comment"},"/*keys_fd指向打开的设备文件，read将从设备文件传送sizeof(t)个字节的数据到&t这个内存地址。函数执行顺利的话返回值是实际读取的字节数*/"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token keyword"},"if"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("t"),(0,e.Wm)("span",{class:"token punctuation"},"."),(0,e.Uk)("type "),(0,e.Wm)("span",{class:"token operator"},"=="),(0,e.Uk)(" EV_KEY"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token keyword"},"if"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("t"),(0,e.Wm)("span",{class:"token punctuation"},"."),(0,e.Uk)("value"),(0,e.Wm)("span",{class:"token operator"},"=="),(0,e.Wm)("span",{class:"token number"},"0"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token operator"},"||"),(0,e.Uk)(" t"),(0,e.Wm)("span",{class:"token punctuation"},"."),(0,e.Uk)("value"),(0,e.Wm)("span",{class:"token operator"},"=="),(0,e.Wm)("span",{class:"token number"},"1"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n                "),(0,e.Wm)("span",{class:"token function"},"printf"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Wm)("span",{class:"token string"},'"key %d %s\\n"'),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)(" t"),(0,e.Wm)("span",{class:"token punctuation"},"."),(0,e.Uk)("code"),(0,e.Wm)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("t"),(0,e.Wm)("span",{class:"token punctuation"},"."),(0,e.Uk)("value"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token operator"},"?"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"Pressed"'),(0,e.Uk)(),(0,e.Wm)("span",{class:"token operator"},":"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token string"},'"Released"'),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("  "),(0,e.Wm)("span",{class:"token comment"},"//t.code值所对应的按键在/usr/include/linux/input-event-codes.h可以查到"),(0,e.Uk)("\n            "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n        "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n    "),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token function"},"close"),(0,e.Wm)("span",{class:"token punctuation"},"("),(0,e.Uk)("keys_fd"),(0,e.Wm)("span",{class:"token punctuation"},")"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n\n"),(0,e.Wm)("span",{class:"token keyword"},"return"),(0,e.Uk)(),(0,e.Wm)("span",{class:"token number"},"0"),(0,e.Wm)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n"),(0,e.Wm)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e.Wm)("div",{class:"line-numbers"},[(0,e.Wm)("span",{class:"line-number"},"1"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"2"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"3"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"4"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"5"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"6"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"7"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"8"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"9"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"10"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"11"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"12"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"13"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"14"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"15"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"16"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"17"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"18"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"19"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"20"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"21"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"22"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"23"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"24"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"25"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"26"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"27"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"28"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"29"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"30"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"31"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"32"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"33"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"34"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"35"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"36"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"37"),(0,e.Wm)("br"),(0,e.Wm)("span",{class:"line-number"},"38"),(0,e.Wm)("br")])],-1),o=(0,e.Wm)("p",null,[(0,e.Wm)("img",{src:t,alt:"附图"}),(0,e.Uk)(" 操作其他的设备类似，不过要提前了解相关的数据结构 但是这种监听是需要有设备文件的读取权限的（"),(0,e.Wm)("code",null,"root"),(0,e.Uk)(" 或者 "),(0,e.Wm)("code",null,"input"),(0,e.Uk)(" 组的用户）， "),(0,e.Wm)("code",null,"read"),(0,e.Uk)(" 函数是系统函数，阻塞地读取设备文件，当设备文件中的缓存为空时挂起等待。")],-1),p=(0,e.Wm)("h2",{id:"扩展阅读",tabindex:"-1"},[(0,e.Wm)("a",{class:"header-anchor",href:"#扩展阅读","aria-hidden":"true"},"#"),(0,e.Uk)(" 扩展阅读")],-1),l=(0,e.Uk)("事件监听方案，推荐"),k={href:"https://www.jianshu.com/p/80cf81413d31",target:"_blank",rel:"noopener noreferrer"},u=(0,e.Uk)("Linux全局事件监听技术"),i={render:function(n,s){const a=(0,e.up)("OutboundLink");return(0,e.wg)(),(0,e.j4)(e.HY,null,[m,c,o,p,(0,e.Wm)("p",null,[l,(0,e.Wm)("a",k,[u,(0,e.Wm)(a)])])],64)}}}}]);